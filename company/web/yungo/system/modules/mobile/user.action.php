<?phpdefined('G_IN_SYSTEM')or exit('No permission resources.');System::load_app_class('memberbase',null,'no');System::load_app_fun('user','go');System::load_app_fun('my','go');System::load_sys_fun('send');class user extends memberbase {	public function __construct(){		parent::__construct();		$this->db = System::load_sys_class("model");		include_once "weixin2.php";	}	public function cook_end(){		_setcookie("uid","",time()-3600);		_setcookie("ushell","",time()-3600);		//_messagemobile("退出成功",WEB_PATH."/mobile/mobile/");		header("location: ".WEB_PATH."/mobile/mobile/");	}	//返回登录页面	public function login($code = null){		$webname = $this->_cfg['web_name'];		$user = $this->userinfo;        session_start();		if($user){			header("Location:".WEB_PATH."/mobile/home/");            exit;		}        elseif (isset($_GET['code']))        {            $code = $_GET["code"];            $response = file_get_contents("https://api.weixin.qq.com/sns/oauth2/access_token?appid=wx99610dc3355e3524&secret=e5ea2d8db69da96086eb7bf15db770f7&code=$code&grant_type=authorization_code");            $jsondecode = json_decode($response,true);            $wx_openid = $jsondecode["openid"];            $_SESSION["wx_openid"] = $wx_openid;            $go_user_info = $this->db->GetOne("select * from `@#_member_band` where `b_code` = '$wx_openid' and `b_type` = 'weixin' LIMIT 1");            if ($go_user_info)            {                $uid = $go_user_info["b_uid"];                $member = $this->db->GetOne("select uid,password,mobile,email from `@#_member` where `uid` = '$uid' LIMIT 1");                $se1 = _setcookie("uid",_encrypt($member['uid']),60*60*24*7);                $se2 = _setcookie("ushell",_encrypt(md5($member['uid'].$member['password'].$member['mobile'].$member['email'])),60*60*24*7);                $callback_url =  WEB_PATH."/mobile/home";                header("Location:$callback_url");            }        }        elseif ($this->is_weixin() && !isset($_GET['code']))        {            $redirect_uri = urlencode("http://wap.iddmall.com/yungo/?/mobile/user/login/");            $wxurl = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx99610dc3355e3524&redirect_uri=$redirect_uri&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect";            header("Location: $wxurl");        }		include templates("mobile/user","login");	}    /*     * 判断是否是微信     */    function is_weixin()    {        if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') !== false )        {            return true;        }        return false;    }	//返回注册页面	public function register(){        $webname=$this->_cfg['web_name'];        $code=$this->segment(4);        session_start();        if($user){            _messagemobile("您已登陆!",WEB_PATH."/mobile/mobile/");        }        elseif (isset($_GET['code']))        {            $code = $_GET["code"];            $response = file_get_contents("https://api.weixin.qq.com/sns/oauth2/access_token?appid=wx99610dc3355e3524&secret=e5ea2d8db69da96086eb7bf15db770f7&code=$code&grant_type=authorization_code");            $jsondecode = json_decode($response,true);            $wx_openid = $jsondecode["openid"];            $_SESSION["wx_openid"] = $wx_openid;            $access_token = $jsondecode["access_token"];            $response= file_get_contents("https://api.weixin.qq.com/sns/userinfo?access_token=$access_token&openid=$wx_openid");            $jsondecode = json_decode($response,true);            $_SESSION["nickname"] = $jsondecode["nickname"];            $_SESSION["img"] = $jsondecode["headimgurl"];            $go_user_info = $this->db->GetOne("select * from `@#_member_band` where `b_code` = '$wx_openid' and `b_type` = 'weixin' LIMIT 1");            if ($go_user_info)            {                $uid = $go_user_info["b_uid"];                $member = $this->db->GetOne("select uid,password,mobile,email from `@#_member` where `uid` = '$uid' LIMIT 1");                $se1 = _setcookie("uid",_encrypt($member['uid']),60*60*24*7);                $se2 = _setcookie("ushell",_encrypt(md5($member['uid'].$member['password'].$member['mobile'].$member['email'])),60*60*24*7);                $callback_url =  WEB_PATH."/mobile/mobile";                header("Location:$callback_url");            }        }        elseif ($this->is_weixin() && !isset($_GET['code']))        {            $redirect_uri = urlencode("http://wap.iddmall.com/yungo/?/mobile/user/register/");            $wxurl = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx99610dc3355e3524&redirect_uri=$redirect_uri&response_type=code&scope=snsapi_base&state=STATE#wechat_redirect";            header("Location: $wxurl");        }		include templates("mobile/user","register");	}	//返回发送验证码页面	public function mobilecode(){	    $webname=$this->_cfg['web_name'];	    $mobilename=$this->segment(4);		include templates("mobile/user","mobilecheck");	}	public function mobilecheck(){	    $webname=$this->_cfg['web_name'];		$title="验证手机";		$time=3000;		$name=$this->segment(4);		$member=$this->db->GetOne("SELECT * FROM `@#_member` WHERE `mobile` = '$name' LIMIT 1");		 //var_dump($member);exit;		if(!$member)_messagemobile("参数不正确!");		if($member['mobilecode']==1){//			_messagemobile("该账号验证成功",WEB_PATH."/mobile/mobile");//            header("location:".WEB_PATH."/mobile/home/");            exit;		}		if($member['mobilecode']==-1){			$sendok = send_mobile_reg_code($name,$member['uid']);//			if($sendok[0]!=1){////					_messagemobile($sendok[1]);//			}            if (!$sendok)            {                _messagemobile("短信发送失败！");            }			header("location:".WEB_PATH."/mobile/user/mobilecheck/".$member['mobile']);			exit;		}		$enname=substr($name,0,3).'****'.substr($name,7,10);		$time=120;		include templates("mobile/user","mobilecheck");	}	public function buyDetail(){	 $webname=$this->_cfg['web_name'];	 $member=$this->userinfo;	 $itemid=intval($this->segment(4));	 $itemlist=$this->db->GetList("select *,a.time as timego,sum(gonumber) as gonumber from `@#_member_go_record` a left join `@#_shoplist` b on a.shopid=b.id where a.uid='$member[uid]' and b.id='$itemid' group by a.id order by a.time" );	 if(!empty($itemlist)){		 if($itemlist[0]['q_end_time']!=''){	   //商品已揭晓			$itemlist[0]['codeState']='已揭晓...';			$itemlist[0]['class']='z-ImgbgC02';	    }elseif($itemlist[0]['shenyurenshu']==0){		//商品购买次数已满			$itemlist[0]['codeState']='已满员...';			$itemlist[0]['class']='z-ImgbgC01';		}else{		//进行中			$itemlist[0]['codeState']='进行中...';			$itemlist[0]['class']='z-ImgbgC01';		}		$bl=($itemlist[0]['canyurenshu']/$itemlist[0]['zongrenshu'])*100;		foreach ($itemlist as $k => $v) {			$count += $v['gonumber'];		}	}	$count = $count ? $count : 0;     //echo "<pre>";	 //print_r($itemlist);	 include templates("mobile/user","userbuyDetail");	}	function qqlogin() {		include_once dirname(__FILE__).'/../api/lib/qq/qqConnectAPI.php';		$qc = new QC();		$db = System::load_sys_class("model");		$qc->qq_login(WEB_PATH.'/mobile/user/qqlogin_callback/');	}	function qqlogin_callback() {		include_once dirname(__FILE__).'/../api/lib/qq/qqConnectAPI.php';		$db = System::load_sys_class("model");		$qc = new QC();		$qq_asc = $qc->qq_callback();		$qq_openid = $qc->get_openid();		$qc = new QC($qq_asc,$qq_openid);		if(empty($qq_openid)){			header("Location: http://" . $_SERVER['HTTP_HOST']);exit;		}		$data = $db->GetOne("select * from `@#_member_band` where `b_code` = '$qq_openid' and `b_type` = 'qq' LIMIT 1");		if ( $data ) {			$member = $this->db->GetOne("select * from `@#_member` where uid='$data[b_uid]'");			if ( $member ) {				_setcookie("uid",_encrypt($member['uid']),60*60*24*7);				_setcookie("ushell",_encrypt(md5($member['uid'].$member['password'].$member['mobile'].$member['email'])),60*60*24*7);				header("location:".WEB_PATH."/mobile/home");				die;			}		}		_messagemobile("初次使用QQ登陆，需绑定您的帐号，请使用手机号或邮箱进行登录，如果您还没有账户请先进行注册。");	}	function wxlogin(){		$user = $this->userinfo;	    $pro = $this->segment(4);	    file_put_contents('t.txt', "\n\r\r\n-----pro:".$pro,FILE_APPEND);		if(!$user){			$code = $this->create_code();			if($pro){				_setcookie("procode",$pro);				$pu = $this->db->GetOne("select * from `@#_activity_code` where `code`='$pro'");				if(empty($pu)){					$pu = $this->db->GetOne("select * from `@#_member` where `code`='$pro'");				}			}else{				$pro=_getcookie("procode");				$pu = $this->db->GetOne("select * from `@#_activity_code` where `code`='$pro'");			}			$p_mobile = $pu['mobile'] ? $pu['mobile'] : '';			$this->db->Query("insert into `@#_activity_code`(`code`,`status`,`pro`) values('$code',0,'{$p_mobile}')");		}else{			if(empty($user['code'])){				$user['code'] = $this->create_code();				$this->db->GetOne("update `@#_member` set code='{$user['code']}' where `uid`='{$user['uid']}'");			}		}		if(!empty($user) && !empty($pro) && $pro==$user['code']){			$mylink = '';			include templates("mobile/index","activity_share");die;		}		session_start();		$state  = md5(uniqid(rand(), TRUE));		$_SESSION["wxState"]	=   $state;		$redirect_uri = urlencode("http://wap.iddmall.com/yungo/?/mobile/user/wx_callback/".$code."/");		$wxurl = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx99610dc3355e3524&redirect_uri=$redirect_uri&response_type=code&scope=snsapi_userinfo&state=$state#wechat_redirect";		header("Location: $wxurl");	}    function wx_callback(){         session_start();		 if($_GET["state"] != $_SESSION["wxState"]){ _messagemobile("登录验证失败!","http://yungo.iddmall.com/?/mobile/user/login");  }		 $code = $_GET["code"];	     $procode = $this->segment(4);	     file_put_contents('t.txt', "\n\r\r\n-----procode:".$procode,FILE_APPEND);	     $response = file_get_contents("https://api.weixin.qq.com/sns/oauth2/access_token?appid=wx99610dc3355e3524&secret=e5ea2d8db69da96086eb7bf15db770f7&code=$code&grant_type=authorization_code");	     $jsondecode = json_decode($response,true);         $wx_openid =$jsondecode["openid"];         if(empty($wx_openid)){         	_messagemobile("绑定出错，请联系管理员。");die;         }		 $access_token =$jsondecode["access_token"];		 $response= file_get_contents("https://api.weixin.qq.com/sns/userinfo?access_token=$access_token&openid=$wx_openid");		 $jsondecode = json_decode($response,true);		 $nickname = $jsondecode["nickname"];		 $go_user_info = $this->db->GetOne("select * from `@#_member_band` where `b_code` = '$wx_openid' and `b_type` = 'weixin' LIMIT 1");		 if(!$go_user_info){		    $userpass = md5("123456");			$go_user_img  ='photo/member.jpg';		    $go_user_time = time();		    $q1 = $this->db->Query("INSERT INTO `@#_member` (`username`,`password`,`img`,`band`,`time`,`money`,`first`,code) VALUES ('$nickname','$userpass','$go_user_img','weixin','$go_user_time',0,1,'$procode')");		    $uid = $this->db->insert_id();			$this->db->Query("INSERT INTO `@#_member_band` (`b_uid`, `b_type`, `b_code`, `b_time`) VALUES ('$uid', 'weixin', '$wx_openid', '$go_user_time')");			$member = $this->db->GetOne("select uid,password,mobile,email from `@#_member` where `uid` = '$uid' LIMIT 1");		    $se1 = _setcookie("uid",_encrypt($member['uid']),60*60*24*7);		    $se2 = _setcookie("ushell",_encrypt(md5($member['uid'].$member['password'].$member['mobile'].$member['email'])),60*60*24*7);			$callback_url =  WEB_PATH."/mobile/home/mobilebind";			header("Location:$callback_url");		 }else{		    $uid = $go_user_info["b_uid"];			$member = $this->db->GetOne("select uid,password,mobile,email from `@#_member` where `uid` = '$uid' LIMIT 1");			$se1 = _setcookie("uid",_encrypt($member['uid']),60*60*24*7);		    $se2 = _setcookie("ushell",_encrypt(md5($member['uid'].$member['password'].$member['mobile'].$member['email'])),60*60*24*7);			if(!$member['mobile']){			    $callback_url =  WEB_PATH."/mobile/home/mobilebind";			    header("Location:$callback_url");            }else{			  	$callback_url =  WEB_PATH."/mobile/activity/";			  	header("Location:$callback_url");			}		 }	}	private function create_code($len = 6){		$randpwd = '';		for ($i = 0; $i < $len; $i++){			$randpwd .= chr(mt_rand(33, 126));		}		$randpwd = base64_encode($randpwd);		return $randpwd;	}    public function findpassword(){        $webname=$this->_cfg['web_name'];        if(isset($_POST['submit']))        {            $name=isset($_POST['name']) ? $_POST['name'] : "";            $txtRegSN=strtoupper($_POST['txtRegSN']);//            if(md5($txtRegSN)!=_getcookie('checkcode'))//            {//                _messagemobile("验证码错误");//            }            $regtype = null;            if(_checkmobile($name))            {                $regtype='mobile';            }            if(_checkemail($name))            {                $regtype='email';            }            if($regtype==null)_messagemobile("帐号类型不正确!",null,3);            $info=$this->DB()->GetOne("SELECT * FROM `@#_member` WHERE $regtype = '$name' LIMIT 1");            if(!$info)_messagemobile("帐号不存在");            header("location:".WEB_PATH."/mobile/user/find".$regtype."check"."/"._encrypt($name));        }        $title = "找回密码";        include templates("mobile/user","findpassword");    }    public function findmobilecheck(){        $title = "手机找回密码";        $time = 120;        $namestr = $this->segment(4);        $name = _encrypt($namestr,"DECODE");        if(strlen($name)!=11)_messagemobile("参数错误！");        $member=$this->DB()->GetOne("SELECT * FROM `@#_member` WHERE `mobile` = '$name' LIMIT 1");        if(!$member)_messagemobile("参数不正确!");        if($member['passcode'] == -1){            //更新验证码            $randcode = rand(100000,999999);            $checkcodes = $randcode.'|'.time();//验证码            $this->DB()->Query("UPDATE `@#_member` SET passcode='$checkcodes' where `uid`='$member[uid]'");            //2014-11-24 lq//            $temp_m_pwd = $this->DB()->GetOne("select value from `@#_caches` where `key` = 'template_mobile_pwd' LIMIT 1");//            $text = str_replace("000000", $randcode, $temp_m_pwd['value']);            $text['code'] = $randcode;            $text['num'] = 10;            $sendok = _sendmobile($name,$text);//            $result = $this->sendMessage($name, $randcode);//            if (!$result)//            {//                _messagemobile('短信发送失败');//            }            if(!$sendok)            {                _messagemobile('短信发送失败');            }            header("location:".WEB_PATH."/mobile/user/findmobilecheck/"._encrypt($member['mobile']));            exit;        }        if(isset($_POST['submit']))        {            $checkcodes = isset($_POST['checkcode']) ? $_POST['checkcode'] : _message("参数不正确!");            if(strlen($checkcodes) != 6)_messagemobile("验证码输入不正确!");            $usercode = explode("|",$member['passcode']);            if($checkcodes != $usercode[0])_messagemobile("验证码输入不正确!");            $urlcheckcode = _encrypt($member['mobile']."|".$member['passcode']);            _setcookie("uid",_encrypt($member['uid']));            _setcookie("ushell",_encrypt(md5($member['uid'].$member['password'].$member['mobile'].$member['email'])));//            _messagemobile("手机验证成功");            _messagemobile("手机验证成功",WEB_PATH."/mobile/user/findok/".$urlcheckcode);//            header("location:".WEB_PATH."/mobile/user/findok/".$urlcheckcode);//            exit;        }        $enname = substr($name,0,3).'****'.substr($name,7,10);        $time = 120;        include templates("mobile/user","findmobilecheck");    }    public function sendMessage($phone, $code)    {            $datas = array($code,'10');            $temp = 50269;            $result = $this->sendTemplateSMS($phone, $datas, $temp);            if($result == NULL ) {                return false;            }            else {                if ($result->statusCode != 0) {                    return false;                }                else {                    return true;                }            }    }    public function findok()    {        $key_find = $this->segment(4);        if(empty($key_find))        {            _messagemobile("未知错误");        }        else        {            $key_find = $this->segment(4);        }        $checkcode = explode("|",_encrypt($key_find,"DECODE"));        if(count($checkcode) != 3)_messagemobile("未知错误",NULL,3);        $emailurl = explode("@",$checkcode[0]);        if($emailurl[1])        {            $sql="select * from `@#_member` where `email`='$checkcode[0]' AND `passcode`= '$checkcode[1]|$checkcode[2]' LIMIT 1";        }        else        {            $sql="select * from `@#_member` where `mobile`='$checkcode[0]' AND `passcode`= '$checkcode[1]|$checkcode[2]' LIMIT 1";        }        $member = $this->DB()->GetOne($sql);        if(!$member)_messagemobile("帐号或验证码错误",NULL,2);        $usercheck = explode("|",$member['passcode']);        $timec = time() - $usercheck[1];        if($timec<(3600*24))        {            $title = "重置密码";            include templates("mobile/user","findok");        }        else        {            $title="验证失败";            include templates("mobile/user","finderror");        }    }    public function resetpassword()    {        if(isset($_POST['submit']))        {            $key = $_POST["hidKey"];            $password = md5($_POST["userpassword"]);            $checkcode = explode("|",_encrypt($key,"DECODE"));            if(count($checkcode)!=3)_messagemobile("未知错误",NULL,3);            $emailurl = explode("@",$checkcode[0]);            if($emailurl[1])            {                $sql="select * from `@#_member` where `email`='$checkcode[0]' AND `passcode`= '$checkcode[1]|$checkcode[2]' LIMIT 1";            }            else            {                $sql="select * from `@#_member` where `mobile`='$checkcode[0]' AND `passcode`= '$checkcode[1]|$checkcode[2]' LIMIT 1";            }            $member=$this->DB()->GetOne($sql);            if(!$member)_messagemobile("未知错误!");            $this->DB()->Query("UPDATE `@#_member` SET `password`='$password',`passcode`='-1' where `uid`='$member[uid]'");            _messagemobile("密码重置成功",WEB_PATH."/mobile/user/login");        }    }}//?>